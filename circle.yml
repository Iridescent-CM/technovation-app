dependencies:
  pre:
    - sudo apt-get update; sudo apt-get install pdftk

machine:
  ruby:
    version:
      2.4.1

  environment:
    PDFTK_PATH: /usr/bin/pdftk
    AIRBRAKE_PROJECT_ID: n-a
    AIRBRAKE_PROJECT_KEY: n-a
    NEW_RELIC_LICENSE_KEY: no-matter
    GOOGLE_MAPS_API_KEY: no-matter-in-test
    HOST_DOMAIN: localhost:3000
    AWS_BUCKET_NAME: technovation-attachments-test
    CAMPAIGN_MONITOR_API_KEY: no-matter-in-test
    STUDENT_LIST_ID: no-matter-in-test
    MENTOR_LIST_ID: no-matter-in-test
    JUDGE_LIST_ID: no-matter-in-test
    REGIONAL_AMBASSADOR_LIST_ID: no-matter-in-test
    PARENT_LIST_ID: no-matter-in-test
    REDIS_URL: redis://127.0.0.1:6379/0
    BONSAI_URL: localhost:9200
    GOOGLE_TIMEZONE_API_KEY: no-matter-in-test
    BING_MAPS_API_KEY: no-matter-in-test
    ENABLE_SUBMISSION_SCORES: yes
    ENABLE_RA_SCORES: yes
    JUDGING_ROUND: QF

general:
  branches:
    ignore:
      - /.*-stable/

deployment:
  qa:
    branch: qa
    commands:
      - |
        cat >~/.netrc <<EOF
        machine api.heroku.com
          login $HEROKU_EMAIL
          password $HEROKU_TOKEN
        machine git.heroku.com
          login $HEROKU_EMAIL
          password $HEROKU_TOKEN
        EOF
      - chmod 600 ~/.netrc # Heroku cli complains about permissions without this
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - git push -f git@heroku.com:technovation-qa.git $CIRCLE_SHA1:refs/heads/qa

  prod:
    branch: production
    commands:
      - |
        cat >~/.netrc <<EOF
        machine api.heroku.com
          login $HEROKU_EMAIL
          password $HEROKU_TOKEN
        machine git.heroku.com
          login $HEROKU_EMAIL
          password $HEROKU_TOKEN
        EOF
      - chmod 600 ~/.netrc # Heroku cli complains about permissions without this
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - git push -f git@heroku.com:technovation.git $CIRCLE_SHA1:refs/heads/production
